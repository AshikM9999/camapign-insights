<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Performance Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6); /* from-indigo-500 to-purple-600 */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #4b5563; /* text-gray-700 */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* bg-gray-300 */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }
        /* Responsive adjustments for charts */
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for consistency */
            margin-bottom: 2rem;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container py-8">
        <h1 class="text-4xl font-bold text-center mb-8 text-indigo-700">Campaign Performance Dashboard</h1>

        <!-- Filter Section (First Fold) -->
        <div class="card mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-indigo-600">Filter Campaigns</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div>
                    <label for="regionFilter" class="block text-sm font-medium text-gray-700 mb-2">Region</label>
                    <select id="regionFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="All">All Regions</option>
                        <option value="North America">North America</option>
                        <option value="Europe">Europe</option>
                        <option value="Asia">Asia</option>
                        <option value="South America">South America</option>
                    </select>
                </div>
                <div>
                    <label for="responsesFilter" class="block text-sm font-medium text-gray-700 mb-2">Responses in Campaign</label>
                    <select id="responsesFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="All">All Ranges</option>
                        <option value="1-10">1 - 10</option>
                        <option value="10-100">10 - 100</option>
                        <option value="100-1000">100 - 1000</option>
                        <option value="1000+">1000+</option>
                    </select>
                </div>
                <div>
                    <button id="searchButton" class="btn-primary w-full md:w-auto">Search Campaigns</button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-spinner"></div>

        <!-- Campaign Results Section -->
        <div id="campaignResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Campaign cards will be inserted here by JavaScript -->
        </div>

        <!-- No Results Message -->
        <div id="noResultsMessage" class="hidden text-center text-gray-600 text-lg py-10">
            No campaigns found matching your criteria. Please adjust your filters.
        </div>

        <!-- Charts Section -->
        <div id="chartsSection" class="hidden">
            <h2 class="text-2xl font-semibold mb-6 text-indigo-600">Campaign Performance Charts</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card chart-container">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">ROI vs. Campaign</h3>
                    <canvas id="roiChart"></canvas>
                </div>
                <div class="card chart-container">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Leads vs. Responses</h3>
                    <canvas id="leadsResponsesChart"></canvas>
                </div>
                <div class="card chart-container">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Cost Per Response vs. Campaign</h3>
                    <canvas id="costPerResponseChart"></canvas>
                </div>
                <div class="card chart-container">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Opportunities & Value Won</h3>
                    <canvas id="opportunitiesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights Modal -->
    <div id="aiInsightsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-indigo-700">AI Insights</h2>
            <p id="modalInsightText" class="text-gray-700 leading-relaxed"></p>
        </div>
    </div>

    <script>
        // Global variable to store campaign data
        let campaignData = [];
        let roiChartInstance, leadsResponsesChartInstance, costPerResponseChartInstance, opportunitiesChartInstance;

        // IMPORTANT: Replace 'YOUR_GOOGLE_SHEET_CSV_PUBLISH_URL_HERE' with the actual URL
        // you get after publishing your Google Sheet to the web as CSV.
        // Example: https://docs.google.com/spreadsheets/d/e/2PACX-1vR.../pub?gid=0&single=true&output=csv
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRERHsfp5PgtW3QB1JlfAG7mi-TLLhWTKgOaUBk3Rr1PUuxuDOcK26gaOVwC_mK54Mo5TzcAJOtqMNi/pub?output=csv'; // PASTE YOUR CSV URL HERE!

        // Function to parse CSV text into an array of objects
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== ''); // Split by line and remove empty lines
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim()); // Get headers from the first line
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                let rowObject = {};
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim() : '';

                    // Attempt to convert known numeric fields to numbers
                    if ([
                        "Actual Cost in Campaign",
                        "Average Cost Per Response",
                        "Leads in Campaign",
                        "Responses in Campaign",
                        "Converted Leads in Campaign",
                        "Opportunities in Campaign",
                        "Value Won Opportunities in Campaign",
                        "ROI",
                        "Average Cost Per Customer"
                    ].includes(header)) {
                        const numValue = parseFloat(value);
                        rowObject[header] = isNaN(numValue) ? value : numValue; // Keep original if not a valid number
                    } else {
                        rowObject[header] = value;
                    }
                });
                data.push(rowObject);
            }
            return data;
        }

        // Function to fetch campaign data from the published Google Sheet CSV
        async function fetchDataFromGoogleSheet() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const campaignResultsDiv = document.getElementById('campaignResults');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const chartsSection = document.getElementById('chartsSection');

            // Show loading indicator
            loadingIndicator.style.display = 'block';
            campaignResultsDiv.innerHTML = ''; // Clear previous results
            noResultsMessage.classList.add('hidden');
            chartsSection.classList.add('hidden');

            try {
                if (GOOGLE_SHEET_CSV_URL === 'YOUR_GOOGLE_SHEET_CSV_PUBLISH_URL_HERE' || !GOOGLE_SHEET_CSV_URL) {
                    throw new Error("Please update 'GOOGLE_SHEET_CSV_URL' in the script with your published Google Sheet CSV link.");
                }

                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}. Check if the URL is correct and the sheet is published.`);
                }
                const csvText = await response.text();
                campaignData = parseCSV(csvText); // Parse the fetched CSV data

                filterAndDisplayCampaigns(); // Display campaigns once data is loaded
            } catch (error) {
                console.error('Error fetching campaign data:', error);
                campaignResultsDiv.innerHTML = `<p class="text-center text-red-600">Failed to load campaign data. Error: ${error.message}. Please check console for details.</p>`;
                noResultsMessage.classList.add('hidden');
                chartsSection.classList.add('hidden');
            } finally {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
            }
        }

        // Function to filter and display campaigns
        function filterAndDisplayCampaigns() {
            const region = document.getElementById('regionFilter').value;
            const responsesRange = document.getElementById('responsesFilter').value;
            const campaignResultsDiv = document.getElementById('campaignResults');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const chartsSection = document.getElementById('chartsSection');

            campaignResultsDiv.innerHTML = ''; // Clear previous results

            let filteredCampaigns = campaignData.filter(campaign => {
                const matchesRegion = (region === 'All' || campaign.Region === region);
                // Ensure Responses in Campaign is treated as a number
                const responses = Number(campaign["Responses in Campaign"]);
                let matchesResponses = true;

                switch (responsesRange) {
                    case '1-10':
                        matchesResponses = (responses >= 1 && responses <= 10);
                        break;
                    case '10-100':
                        matchesResponses = (responses >= 10 && responses <= 100);
                        break;
                    case '100-1000':
                        matchesResponses = (responses >= 100 && responses <= 1000);
                        break;
                    case '1000+':
                        matchesResponses = (responses > 1000);
                        break;
                    case 'All':
                    default:
                        matchesResponses = true;
                        break;
                }
                return matchesRegion && matchesResponses;
            });

            if (filteredCampaigns.length === 0) {
                noResultsMessage.classList.remove('hidden');
                chartsSection.classList.add('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
                chartsSection.classList.remove('hidden');
                filteredCampaigns.forEach(campaign => {
                    const campaignCard = document.createElement('div');
                    campaignCard.className = 'card flex flex-col justify-between';
                    campaignCard.innerHTML = `
                        <h3 class="text-xl font-semibold mb-3 text-indigo-700">${campaign["Campaign Name"]}</h3>
                        <p class="text-sm text-gray-600 mb-2"><strong>Region:</strong> ${campaign.Region}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Actual Cost:</strong> $${campaign["Actual Cost in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Avg. Cost/Response:</strong> $${campaign["Average Cost Per Response"].toFixed(2)}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Leads:</strong> ${campaign["Leads in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Responses:</strong> ${campaign["Responses in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Converted Leads:</strong> ${campaign["Converted Leads in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Opportunities:</strong> ${campaign["Opportunities in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Value Won:</strong> $${campaign["Value Won Opportunities in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>ROI:</strong> ${campaign["ROI"].toLocaleString()}%</p>
                        <p class="text-sm text-gray-600 mb-4"><strong>Avg. Cost/Customer:</strong> $${campaign["Average Cost Per Customer"].toFixed(2)}</p>
                        <button class="btn-secondary mt-auto" onclick="showAIInsights('${escapeHtml(campaign["AI Insights"])}')">AI Insights</button>
                    `;
                    campaignResultsDiv.appendChild(campaignCard);
                });
                renderCharts(filteredCampaigns);
            }
        }

        // Helper function to escape HTML for safe display in onclick
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Function to show AI Insights modal
        function showAIInsights(insightText) {
            document.getElementById('modalInsightText').innerText = insightText;
            document.getElementById('aiInsightsModal').style.display = 'flex'; // Use flex to center
        }

        // Function to close AI Insights modal
        function closeModal() {
            document.getElementById('aiInsightsModal').style.display = 'none';
        }

        // Function to render charts
        function renderCharts(data) {
            const campaignNames = data.map(c => c["Campaign Name"]);
            const roiValues = data.map(c => c["ROI"]);
            const leadsValues = data.map(c => c["Leads in Campaign"]);
            const responsesValues = data.map(c => c["Responses in Campaign"]);
            const costPerResponseValues = data.map(c => c["Average Cost Per Response"]);
            const opportunitiesValues = data.map(c => c["Opportunities in Campaign"]);
            const valueWonValues = data.map(c => c["Value Won Opportunities in Campaign"]);

            // Destroy existing chart instances if they exist
            if (roiChartInstance) roiChartInstance.destroy();
            if (leadsResponsesChartInstance) leadsResponsesChartInstance.destroy();
            if (costPerResponseChartInstance) costPerResponseChartInstance.destroy();
            if (opportunitiesChartInstance) opportunitiesChartInstance.destroy();

            // ROI Chart
            const roiCtx = document.getElementById('roiChart').getContext('2d');
            roiChartInstance = new Chart(roiCtx, {
                type: 'bar',
                data: {
                    labels: campaignNames,
                    datasets: [{
                        label: 'ROI (%)',
                        data: roiValues,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)', // indigo-500
                        borderColor: 'rgba(79, 70, 229, 1)', // indigo-600
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ROI (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Campaign Name'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Leads vs. Responses Chart
            const leadsResponsesCtx = document.getElementById('leadsResponsesChart').getContext('2d');
            leadsResponsesChartInstance = new Chart(leadsResponsesCtx, {
                type: 'line',
                data: {
                    labels: campaignNames,
                    datasets: [
                        {
                            label: 'Leads in Campaign',
                            data: leadsValues,
                            borderColor: 'rgba(139, 92, 246, 0.8)', // purple-500
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Responses in Campaign',
                            data: responsesValues,
                            borderColor: 'rgba(34, 197, 94, 0.8)', // green-500
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Campaign Name'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });

            // Cost Per Response Chart
            const costPerResponseCtx = document.getElementById('costPerResponseChart').getContext('2d');
            costPerResponseChartInstance = new Chart(costPerResponseCtx, {
                type: 'bar',
                data: {
                    labels: campaignNames,
                    datasets: [{
                        label: 'Avg. Cost Per Response ($)',
                        data: costPerResponseValues,
                        backgroundColor: 'rgba(251, 191, 36, 0.8)', // amber-400
                        borderColor: 'rgba(245, 158, 11, 1)', // amber-500
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Campaign Name'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            // Opportunities & Value Won Chart
            const opportunitiesCtx = document.getElementById('opportunitiesChart').getContext('2d');
            opportunitiesChartInstance = new Chart(opportunitiesCtx, {
                type: 'bar',
                data: {
                    labels: campaignNames,
                    datasets: [
                        {
                            label: 'Opportunities in Campaign',
                            data: opportunitiesValues,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', // blue-500
                            borderColor: 'rgba(37, 99, 235, 1)', // blue-600
                            borderWidth: 1
                        },
                        {
                            label: 'Value Won Opportunities ($)',
                            data: valueWonValues,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)', // red-500
                            borderColor: 'rgba(220, 38, 38, 1)', // red-600
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count / Value ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Campaign Name'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label.includes('Value')) {
                                        label += '$' + context.parsed.y.toLocaleString();
                                    } else {
                                        label += context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Event Listener for Search Button
        document.getElementById('searchButton').addEventListener('click', filterAndDisplayCampaigns);

        // Initial data fetch and display on page load
        window.onload = () => {
            fetchDataFromGoogleSheet();
        };

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('aiInsightsModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>

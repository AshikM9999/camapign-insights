<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Performance Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6); /* from-indigo-500 to-purple-600 */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #4b5563; /* text-gray-700 */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* bg-gray-300 */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }
        /* Responsive adjustments for charts */
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for consistency */
            margin-bottom: 2rem;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container py-8">
        <h1 class="text-4xl font-bold text-center mb-8 text-indigo-700">Campaign Performance Dashboard</h1>

        <!-- Filter Section (First Fold) -->
        <div class="card mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-indigo-600">Filter Campaigns</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div>
                    <label for="regionFilter" class="block text-sm font-medium text-gray-700 mb-2">Region</label>
                    <select id="regionFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="All">All Regions</option>
                        <option value="North America">North America</option>
                        <option value="Europe">Europe</option>
                        <option value="Asia">Asia</option>
                        <option value="South America">South America</option>
                    </select>
                </div>
                <div>
                    <label for="responsesFilter" class="block text-sm font-medium text-gray-700 mb-2">Responses in Campaign</label>
                    <select id="responsesFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="All">All Ranges</option>
                        <option value="1-10">1 - 10</option>
                        <option value="10-100">10 - 100</option>
                        <option value="100-1000">100 - 1000</option>
                        <option value="1000+">1000+</option>
                    </select>
                </div>
                <div>
                    <button id="searchButton" class="btn-primary w-full md:w-auto">Search Campaigns</button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-spinner"></div>

        <!-- Campaign Results Section -->
        <div id="campaignResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Campaign cards will be inserted here by JavaScript -->
        </div>

        <!-- No Results Message -->
        <div id="noResultsMessage" class="hidden text-center text-gray-600 text-lg py-10">
            No campaigns found matching your criteria. Please adjust your filters.
        </div>

        <!-- Charts Section -->
        <div id="chartsSection" class="hidden">
            <h2 class="text-2xl font-semibold mb-6 text-indigo-600">Campaign Performance Charts</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card chart-container">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">ROI vs. Campaign</h3>
                    <canvas id="roiChart"></canvas>
                </div>
                <div class="card chart-container">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Leads vs. Responses</h3>
                    <canvas id="leadsResponsesChart"></canvas>
                </div>
                <div class="card chart-container">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Cost Per Response vs. Campaign</h3>
                    <canvas id="costPerResponseChart"></canvas>
                </div>
                <div class="card chart-container">
                    <h3 class="text-xl font-medium mb-4 text-gray-700">Opportunities & Value Won</h3>
                    <canvas id="opportunitiesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights Modal -->
    <div id="aiInsightsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-indigo-700">AI Insights</h2>
            <p id="modalInsightText" class="text-gray-700 leading-relaxed"></p>
        </div>
    </div>

    <script>
        // Global variable to store campaign data
        let campaignData = [];
        let roiChartInstance, leadsResponsesChartInstance, costPerResponseChartInstance, opportunitiesChartInstance;

        // Simulated Google Sheet Data for demonstration.
        // In a real application, this data would be fetched from a backend service
        // that connects to your Google Sheet (e.g., Google Apps Script, Firebase Functions).
        // The structure of the fetched data should match this array of objects.
        const simulatedFetchedData = [
            {
                "Campaign Name": "Summer Sale 2024",
                "Region": "North America",
                "Actual Cost in Campaign": 5000,
                "Average Cost Per Response": 5,
                "Leads in Campaign": 800,
                "Responses in Campaign": 1000,
                "Converted Leads in Campaign": 150,
                "Opportunities in Campaign": 200,
                "Value Won Opportunities in Campaign": 75000,
                "ROI": 1400,
                "Average Cost Per Customer": 33.33,
                "AI Insights": "This campaign showed strong engagement in North America, with a good conversion rate. Consider replicating strategies for future regional campaigns. The ROI is excellent, indicating highly effective targeting."
            },
            {
                "Campaign Name": "Winter Collection Launch",
                "Region": "Europe",
                "Actual Cost in Campaign": 7000,
                "Average Cost Per Response": 7,
                "Leads in Campaign": 600,
                "Responses in Campaign": 800,
                "Converted Leads in Campaign": 100,
                "Opportunities in Campaign": 120,
                "Value Won Opportunities in Campaign": 60000,
                "ROI": 757,
                "Average Cost Per Customer": 70,
                "AI Insights": "European launch performed moderately. While responses were decent, the cost per customer is higher. Analyze ad creatives and targeting for potential optimization in future campaigns. ROI is positive but has room for improvement."
            },
            {
                "Campaign Name": "Back-to-School Promo",
                "Region": "North America",
                "Actual Cost in Campaign": 3000,
                "Average Cost Per Response": 3,
                "Leads in Campaign": 900,
                "Responses in Campaign": 1200,
                "Converted Leads in Campaign": 200,
                "Opportunities in Campaign": 250,
                "Value Won Opportunities in Campaign": 80000,
                "ROI": 2566,
                "Average Cost Per Customer": 15,
                "AI Insights": "An exceptionally successful campaign with very low cost per response and high ROI. The high number of converted leads suggests strong product-market fit. This campaign sets a benchmark for efficiency."
            },
            {
                "Campaign Name": "Holiday Season Blast",
                "Region": "Asia",
                "Actual Cost in Campaign": 10000,
                "Average Cost Per Response": 10,
                "Leads in Campaign": 500,
                "Responses in Campaign": 600,
                "Converted Leads in Campaign": 80,
                "Opportunities in Campaign": 100,
                "Value Won Opportunities in Campaign": 40000,
                "ROI": 300,
                "Average Cost Per Customer": 125,
                "AI Insights": "Performance in Asia was below expectations. High cost per response and per customer indicate issues with targeting or messaging. A/B test different approaches for this region. ROI is positive but minimal."
            },
            {
                "Campaign Name": "Spring Refresh",
                "Region": "Europe",
                "Actual Cost in Campaign": 4500,
                "Average Cost Per Response": 4.5,
                "Leads in Campaign": 700,
                "Responses in Campaign": 950,
                "Converted Leads in Campaign": 130,
                "Opportunities in Campaign": 180,
                "Value Won Opportunities in Campaign": 55000,
                "ROI": 1122,
                "Average Cost Per Customer": 34.62,
                "AI Insights": "Solid performance in Europe with good ROI. The campaign effectively generated leads and conversions. Continue to monitor average cost per customer for any fluctuations."
            },
            {
                "Campaign Name": "New Year, New You",
                "Region": "North America",
                "Actual Cost in Campaign": 6000,
                "Average Cost Per Response": 6,
                "Leads in Campaign": 750,
                "Responses in Campaign": 900,
                "Converted Leads in Campaign": 160,
                "Opportunities in Campaign": 210,
                "Value Won Opportunities in Campaign": 70000,
                "ROI": 1066,
                "Average Cost Per Customer": 37.5,
                "AI Insights": "Consistent performance in North America. The campaign achieved a healthy ROI and converted a good number of leads. Explore opportunities for upselling or cross-selling to existing customers."
            },
            {
                "Campaign Name": "Local Market Blitz",
                "Region": "South America",
                "Actual Cost in Campaign": 2000,
                "Average Cost Per Response": 2,
                "Leads in Campaign": 100,
                "Responses in Campaign": 150,
                "Converted Leads in Campaign": 20,
                "Opportunities in Campaign": 30,
                "Value Won Opportunities in Campaign": 10000,
                "ROI": 400,
                "Average Cost Per Customer": 100,
                "AI Insights": "A smaller, targeted campaign. While the numbers are lower, the cost per response is very good. The cost per customer is high, suggesting a need to refine the conversion funnel for this region."
            },
            {
                "Campaign Name": "Global Brand Awareness",
                "Region": "Asia",
                "Actual Cost in Campaign": 15000,
                "Average Cost Per Response": 15,
                "Leads in Campaign": 300,
                "Responses in Campaign": 400,
                "Converted Leads in Campaign": 50,
                "Opportunities in Campaign": 70,
                "Value Won Opportunities in Campaign": 25000,
                "ROI": 66,
                "Average Cost Per Customer": 300,
                "AI Insights": "This campaign had a very low ROI and high costs. It seems more focused on awareness than direct conversions. Re-evaluate objectives and metrics for such campaigns, or adjust strategy for better lead generation."
            },
            {
                "Campaign Name": "Early Bird Special",
                "Region": "North America",
                "Actual Cost in Campaign": 2500,
                "Average Cost Per Response": 2.5,
                "Leads in Campaign": 850,
                "Responses in Campaign": 1100,
                "Converted Leads in Campaign": 180,
                "Opportunities in Campaign": 220,
                "Value Won Opportunities in Campaign": 72000,
                "ROI": 2780,
                "Average Cost Per Customer": 13.89,
                "AI Insights": "An outstanding campaign with exceptional ROI and very low cost per customer. The early bird strategy clearly resonated with the audience. This is a highly effective model to repeat."
            },
            {
                "Campaign Name": "Autumn Collection",
                "Region": "Europe",
                "Actual Cost in Campaign": 5500,
                "Average Cost Per Response": 5.5,
                "Leads in Campaign": 650,
                "Responses in Campaign": 850,
                "Converted Leads in Campaign": 110,
                "Opportunities in Campaign": 140,
                "Value Won Opportunities in Campaign": 50000,
                "ROI": 809,
                "Average Cost Per Customer": 50,
                "AI Insights": "Good performance for the Autumn collection in Europe. The ROI is healthy, and the conversion rate is stable. Consider segmenting the audience further for even better targeting."
            },
            {
                "Campaign Name": "Flash Sale",
                "Region": "Asia",
                "Actual Cost in Campaign": 1500,
                "Average Cost Per Response": 1.5,
                "Leads in Campaign": 120,
                "Responses in Campaign": 180,
                "Converted Leads in Campaign": 25,
                "Opportunities in Campaign": 35,
                "Value Won Opportunities in Campaign": 12000,
                "ROI": 700,
                "Average Cost Per Customer": 60,
                "AI Insights": "A small but effective flash sale. The cost per response is very low, indicating good immediate engagement. Focus on increasing the volume for similar future campaigns."
            },
            {
                "Campaign Name": "End of Year Clearance",
                "Region": "North America",
                "Actual Cost in Campaign": 8000,
                "Average Cost Per Response": 8,
                "Leads in Campaign": 400,
                "Responses in Campaign": 500,
                "Converted Leads in Campaign": 70,
                "Opportunities in Campaign": 90,
                "Value Won Opportunities in Campaign": 35000,
                "ROI": 337,
                "Average Cost Per Customer": 114.28,
                "AI Insights": "The clearance campaign had a lower ROI and higher cost per customer. This is typical for clearance sales, but review if the discount strategy was optimal for profitability."
            }
        ];

        // Function to fetch campaign data from a simulated Google Sheet API
        async function fetchDataFromGoogleSheet() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const campaignResultsDiv = document.getElementById('campaignResults');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const chartsSection = document.getElementById('chartsSection');

            // Show loading indicator
            loadingIndicator.style.display = 'block';
            campaignResultsDiv.innerHTML = ''; // Clear previous results
            noResultsMessage.classList.add('hidden');
            chartsSection.classList.add('hidden');

            try {
                // In a real scenario, you would replace this with a fetch call to your Google Apps Script web app URL.
                // Example: const response = await fetch('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL');
                // const data = await response.json();
                // campaignData = data; // Assign fetched data to the global variable

                // Simulating network delay and data assignment
                await new Promise(resolve => setTimeout(() => {
                    campaignData = simulatedFetchedData; // Assign simulated data
                    resolve();
                }, 1500)); // Simulate 1.5 seconds loading time

                filterAndDisplayCampaigns(); // Display campaigns once data is loaded
            } catch (error) {
                console.error('Error fetching campaign data:', error);
                campaignResultsDiv.innerHTML = '<p class="text-center text-red-600">Failed to load campaign data. Please try again later.</p>';
                noResultsMessage.classList.add('hidden'); // Ensure it's hidden if there's a load error
                chartsSection.classList.add('hidden');
            } finally {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
            }
        }

        // Function to filter and display campaigns
        function filterAndDisplayCampaigns() {
            const region = document.getElementById('regionFilter').value;
            const responsesRange = document.getElementById('responsesFilter').value;
            const campaignResultsDiv = document.getElementById('campaignResults');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const chartsSection = document.getElementById('chartsSection');

            campaignResultsDiv.innerHTML = ''; // Clear previous results

            let filteredCampaigns = campaignData.filter(campaign => {
                const matchesRegion = (region === 'All' || campaign.Region === region);
                const responses = campaign["Responses in Campaign"];
                let matchesResponses = true;

                switch (responsesRange) {
                    case '1-10':
                        matchesResponses = (responses >= 1 && responses <= 10);
                        break;
                    case '10-100':
                        matchesResponses = (responses >= 10 && responses <= 100);
                        break;
                    case '100-1000':
                        matchesResponses = (responses >= 100 && responses <= 1000);
                        break;
                    case '1000+':
                        matchesResponses = (responses > 1000);
                        break;
                    case 'All':
                    default:
                        matchesResponses = true;
                        break;
                }
                return matchesRegion && matchesResponses;
            });

            if (filteredCampaigns.length === 0) {
                noResultsMessage.classList.remove('hidden');
                chartsSection.classList.add('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
                chartsSection.classList.remove('hidden');
                filteredCampaigns.forEach(campaign => {
                    const campaignCard = document.createElement('div');
                    campaignCard.className = 'card flex flex-col justify-between';
                    campaignCard.innerHTML = `
                        <h3 class="text-xl font-semibold mb-3 text-indigo-700">${campaign["Campaign Name"]}</h3>
                        <p class="text-sm text-gray-600 mb-2"><strong>Region:</strong> ${campaign.Region}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Actual Cost:</strong> $${campaign["Actual Cost in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Avg. Cost/Response:</strong> $${campaign["Average Cost Per Response"].toFixed(2)}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Leads:</strong> ${campaign["Leads in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Responses:</strong> ${campaign["Responses in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Converted Leads:</strong> ${campaign["Converted Leads in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Opportunities:</strong> ${campaign["Opportunities in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Value Won:</strong> $${campaign["Value Won Opportunities in Campaign"].toLocaleString()}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>ROI:</strong> ${campaign["ROI"].toLocaleString()}%</p>
                        <p class="text-sm text-gray-600 mb-4"><strong>Avg. Cost/Customer:</strong> $${campaign["Average Cost Per Customer"].toFixed(2)}</p>
                        <button class="btn-secondary mt-auto" onclick="showAIInsights('${escapeHtml(campaign["AI Insights"])}')">AI Insights</button>
                    `;
                    campaignResultsDiv.appendChild(campaignCard);
                });
                renderCharts(filteredCampaigns);
            }
        }

        // Helper function to escape HTML for safe display in onclick
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Function to show AI Insights modal
        function showAIInsights(insightText) {
            document.getElementById('modalInsightText').innerText = insightText;
            document.getElementById('aiInsightsModal').style.display = 'flex'; // Use flex to center
        }

        // Function to close AI Insights modal
        function closeModal() {
            document.getElementById('aiInsightsModal').style.display = 'none';
        }

        // Function to render charts
        function renderCharts(data) {
            const campaignNames = data.map(c => c["Campaign Name"]);
            const roiValues = data.map(c => c["ROI"]);
            const leadsValues = data.map(c => c["Leads in Campaign"]);
            const responsesValues = data.map(c => c["Responses in Campaign"]);
            const costPerResponseValues = data.map(c => c["Average Cost Per Response"]);
            const opportunitiesValues = data.
